<!DOCTYPE html>
<html>
<head>
    <title>üî• Smart Screen Share (FIXED)</title>
    <style>
        body { font-family: Arial; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        .options { display: flex; flex-direction: column; gap: 20px; max-width: 500px; margin: 40px auto; }
        .share-btn { padding: 30px; background: rgba(255,255,255,0.15); border: 3px solid rgba(255,255,255,0.4); border-radius: 20px; font-size: 24px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(15px); text-align: center; }
        .share-btn:hover { background: rgba(255,255,255,0.25); border-color: #4CAF50; transform: scale(1.05); }
        
        .preview-video { width: 100%; max-width: 1000px; height: 60vh; max-height: 600px; object-fit: cover; border: 4px solid #fff; border-radius: 20px; margin: 20px auto; display: block; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        
        button { padding: 15px 30px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; transition: all 0.3s; }
        button:hover { background: #45a049; transform: translateY(-2px); }
        button:disabled { background: #666; cursor: not-allowed; }
        
        input { width: 100%; max-width: 350px; padding: 20px; margin: 15px 0; border: none; border-radius: 12px; font-size: 28px; text-align: center; text-transform: uppercase; background: rgba(255,255,255,0.9); color: #333; }
        
        .room-code { font-size: 70px; font-weight: bold; color: #4CAF50; background: rgba(255,255,255,0.95); color: #333; padding: 30px; border-radius: 20px; text-align: center; margin: 30px 0; letter-spacing: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        
        .panel { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 25px; backdrop-filter: blur(15px); text-align: center; max-width: 1000px; margin: 20px auto; }
        #status { color: #4CAF50; font-weight: bold; font-size: 22px; padding: 20px; background: rgba(76,175,80,0.2); border-radius: 15px; margin: 25px 0; }
        .error { background: rgba(244,67,54,0.2) !important; color: #f44336 !important; }
        
        #fullscreen-btn { background: #ff9800; font-size: 20px; padding: 18px 35px; }
        #main-panel, #preview-panel { display: none; }
        .device-info { font-size: 18px; margin: 15px 0; opacity: 0.9; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1 style="text-align: center; font-size: 36px; margin-bottom: 20px;">üî• Smart Screen Share (FIXED)</h1>
    
    <div class="options" id="options">
        <div class="share-btn" onclick="selectShareMode()">
            <div style="font-size: 64px; margin-bottom: 15px;">üì±üñ•Ô∏è</div>
            <div style="font-size: 28px; font-weight: bold;">Share Screen</div>
            <div class="device-info" id="deviceInfo">Detecting device...</div>
        </div>
    </div>

    <div style="max-width: 500px; margin: 30px auto; text-align: center;">
        <h3 style="margin-bottom: 20px;">üîë Ya Kisi Room Join Karo</h3>
        <input id="globalRoomCodeInput" type="text" maxlength="4" placeholder="ABCD">
        <button onclick="joinAnyRoom()">üöÄ Join Room</button>
    </div>

    <div id="preview-panel" class="panel">
        <video id="previewVideo" class="preview-video" autoplay playsinline muted></video>
        <div id="previewStatus">Waiting for stream...</div>
        <button id="fullscreen-btn" onclick="toggleFullscreen()" style="display:none;">üì± Fullscreen</button>
    </div>

    <div id="main-panel" class="panel">
        <div id="status">Ready to share...</div>
        <div id="roomCode" class="room-code"></div>
        <video id="localVideo" class="preview-video" autoplay muted playsinline style="display:none;"></video>
        <button id="startBtn" onclick="startScreenShare()" style="font-size: 22px; padding: 20px 50px;">‚ñ∂Ô∏è Start Screen + Audio</button>
    </div>

    <script>
        let localStream, peerConnection, currentRoomCode, previewStream, isSharer = false;
        const config = { iceServers: [{urls: 'stun:stun.l.google.com:19302'}] };
        const rooms = {}; // { roomCode: { offer, answer, peers: [] } }

        function detectDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            return isMobile ? 'üì± Phone Screen' : 'üñ•Ô∏è Desktop Screen';
        }

        function selectShareMode() {
            document.getElementById('options').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
            
            currentRoomCode = generateRoomCode();
            document.getElementById('roomCode').textContent = currentRoomCode;
            document.getElementById('status').innerHTML = `${detectDevice()}<br>‚úÖ Room: <span style="color:#4CAF50;font-size:30px;">${currentRoomCode}</span><br>Share this code!`;
            isSharer = true;
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2,6).toUpperCase();
        }

        function joinAnyRoom() {
            const code = document.getElementById('globalRoomCodeInput').value.toUpperCase();
            if (code.length !== 4) {
                alert('‚ùå 4 digit code daalo!');
                return;
            }
            
            if (!rooms[code]) {
                // Auto-create room if not exists (for viewer)
                rooms[code] = { offer: null, answer: null, peers: [] };
                setTimeout(() => {
                    document.getElementById('status').innerHTML = `‚è≥ Room ${code} creating...`;
                }, 100);
            }
            
            document.getElementById('options').style.display = 'none';
            document.getElementById('preview-panel').style.display = 'block';
            currentRoomCode = code;
            document.getElementById('previewStatus').innerHTML = `üîÑ Connecting to ${code}...`;
            isSharer = false;
            
            // Wait for offer or create peer connection
            setTimeout(() => createViewerConnection(), 500);
        }

        async function startScreenShare() {
            try {
                // Create room first
                rooms[currentRoomCode] = { offer: null, answer: null, peers: [] };
                
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: {ideal: 1920}, height: {ideal: 1080}, frameRate: {ideal: 60} },
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').style.display = 'block';
                
                document.getElementById('status').innerHTML = `üé• ${detectDevice()} LIVE!<br>Room: ${currentRoomCode}<br>Waiting for viewers...`;
                
                // Create sharer connection
                createSharerConnection();
                
            } catch(err) {
                document.getElementById('status').innerHTML = '‚ùå Permission denied! Chrome/Edge use karo.';
                document.getElementById('status').className = 'error';
            }
        }

        function createSharerConnection() {
            peerConnection = new RTCPeerConnection(config);
            
            // Add tracks
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Handle incoming streams
            peerConnection.ontrack = (event) => {
                console.log('Remote stream received');
                previewStream = event.streams[0];
            };
            
            // Auto create offer
            peerConnection.onnegotiationneeded = async () => {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    rooms[currentRoomCode].offer = offer;
                    console.log('Offer created:', currentRoomCode);
                } catch(e) {
                    console.error('Offer error:', e);
                }
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // Store ICE candidates too
                    if (!rooms[currentRoomCode].candidates) rooms[currentRoomCode].candidates = [];
                    rooms[currentRoomCode].candidates.push(event.candidate);
                }
            };
            
            // Trigger offer creation
            peerConnection.onnegotiationneeded();
        }

        function createViewerConnection() {
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.ontrack = (event) => {
                console.log('Stream received!');
                document.getElementById('previewVideo').srcObject = event.streams[0];
                document.getElementById('previewStatus').innerHTML = 'üéâ Connected! Full HD + Audio üî•';
                document.getElementById('fullscreen-btn').style.display = 'inline-block';
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && rooms[currentRoomCode]) {
                    if (!rooms[currentRoomCode].viewerCandidates) rooms[currentRoomCode].viewerCandidates = [];
                    rooms[currentRoomCode].viewerCandidates.push(event.candidate);
                }
            };
            
            // Try to connect to offer
            setTimeout(() => {
                if (rooms[currentRoomCode]?.offer) {
                    connectAsViewer();
                } else {
                    document.getElementById('previewStatus').innerHTML = `‚è≥ Waiting for ${currentRoomCode} to start sharing...`;
                    // Poll every 2 seconds
                    const interval = setInterval(() => {
                        if (rooms[currentRoomCode]?.offer) {
                            clearInterval(interval);
                            connectAsViewer();
                        }
                    }, 2000);
                }
            }, 1000);
        }

        async function connectAsViewer() {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(rooms[currentRoomCode].offer));
                
                // Add ICE candidates
                if (rooms[currentRoomCode].candidates) {
                    rooms[currentRoomCode].candidates.forEach(candidate => {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                rooms[currentRoomCode].answer = answer;
                
                document.getElementById('previewStatus').innerHTML = '‚úÖ Connected! Stream loading...';
            } catch(err) {
                console.error('Viewer connect error:', err);
                document.getElementById('previewStatus').innerHTML = '‚ùå Connection failed. Try again.';
                document.getElementById('previewStatus').className = 'error';
            }
        }

        function toggleFullscreen() {
            const video = document.getElementById('previewVideo');
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(() => {
                    document.documentElement.requestFullscreen();
                });
            } else {
                document.exitFullscreen();
            }
        }

        window.onload = () => {
            document.getElementById('deviceInfo').textContent = detectDevice();
        };
    </script>
</body>
</html>
