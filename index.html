<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Screen Share (Firebase RTDB)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#1e1e2f; color:#fff; }
    h1 { text-align:center; }
    .container { max-width: 900px; margin: 0 auto; }
    .buttons { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:20px 0; }
    button { padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
    #shareBtn { background:#4CAF50; color:#fff; }
    #joinBtn { background:#2196F3; color:#fff; }
    #hangupBtn { background:#f44336; color:#fff; }
    input { padding:10px; font-size:18px; border-radius:6px; border:none; text-align:center; text-transform:uppercase; }
    #roomInput { width:130px; }
    #roomCodeDisplay { font-size:32px; font-weight:bold; margin-top:10px; text-align:center; letter-spacing:8px; }
    video { width:100%; max-height:480px; background:#000; border-radius:10px; margin-top:15px; }
    #status { margin-top:10px; padding:10px; border-radius:6px; background:#333; font-size:14px; }
    #fullscreenBtn { margin-top:10px; background:#ff9800; color:#fff; }
  </style>
</head>
<body>
  <h1>Smart Screen Share (Firebase RTDB)</h1>
  <div class="container">
    <div class="buttons">
      <button id="shareBtn">Share Screen (Create Room)</button>
      <input id="roomInput" maxlength="4" placeholder="CODE" />
      <button id="joinBtn">Join Room</button>
      <button id="hangupBtn" disabled>Hang Up</button>
    </div>
    <div id="roomCodeDisplay"></div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="fullscreenBtn" style="display:none;">Fullscreen</button>
    <div id="status">Idle...</div>
  </div>

  <!-- Firebase v9 compat (RTDB) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ==== YOUR FIREBASE CONFIG ====
    const firebaseConfig = {
      apiKey: "AIzaSyDLctihOhDilX-Fd7NLA1KNoKQGQH_-3bM",
      authDomain: "freescreenshare-5be50.firebaseapp.com",
      projectId: "freescreenshare-5be50",
      storageBucket: "freescreenshare-5be50.firebasestorage.app",
      messagingSenderId: "876058704234",
      appId: "1:876058704234:web:d937db2c48cf28bef7cd13",
      databaseURL: "https://freescreenshare-5be50-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==== WebRTC ====
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let pc = null;
    let localStream = null;
    let roomCode = null;
    let isCaller = false;

    const shareBtn = document.getElementById('shareBtn');
    const joinBtn = document.getElementById('joinBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const roomInput = document.getElementById('roomInput');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const statusEl = document.getElementById('status');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    function logStatus(msg) {
      console.log(msg);
      statusEl.textContent = msg;
    }

    function genRoomCode() {
      return Math.random().toString(36).substring(2,6).toUpperCase();
    }

    async function createPeerConnection() {
      pc = new RTCPeerConnection(servers);

      pc.onicecandidate = async (event) => {
        if (event.candidate && roomCode) {
          const path = isCaller ? `rooms/${roomCode}/offerCandidates` : `rooms/${roomCode}/answerCandidates`;
          await db.ref(path).push(event.candidate.toJSON());
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
        fullscreenBtn.style.display = 'inline-block';
      };

      hangupBtn.disabled = false;
    }

    async function startShare() {
      roomCode = genRoomCode();
      isCaller = true;
      roomCodeDisplay.textContent = roomCode;
      roomInput.value = roomCode;
      logStatus('Creating room ' + roomCode + ' and capturing screen...');

      await createPeerConnection();

      // Screen + audio
      localStream = await navigator.mediaDevices.getDisplayMedia({
        video: { width: {ideal:1920}, height:{ideal:1080}, frameRate:{ideal:60} },
        audio: true
      });
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      const roomRef = db.ref('rooms/' + roomCode);
      await roomRef.remove(); // clear old if any

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.set({ offer });

      logStatus('Room ' + roomCode + ' ready. Join from another device with this code.');

      // Listen for answer
      roomRef.child('answer').on('value', async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          logStatus('Answer received, completing connection...');
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // Listen for answer candidates
      roomRef.child('answerCandidates').on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    }

    async function joinRoom() {
      roomCode = roomInput.value.trim().toUpperCase();
      if (!roomCode) {
        alert('Enter room code');
        return;
      }
      isCaller = false;
      roomCodeDisplay.textContent = roomCode;
      logStatus('Joining room ' + roomCode + '...');

      const roomRef = db.ref('rooms/' + roomCode);
      const roomSnapshot = await roomRef.get();
      if (!roomSnapshot.exists() || !roomSnapshot.val().offer) {
        logStatus('Room not found or offer missing. Wait for sharer to start.');
        return;
      }

      await createPeerConnection();

      // Receive screen only, no local tracks (pure viewer)
      const offer = roomSnapshot.val().offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child('answer').set(answer);
      logStatus('Joined room ' + roomCode + ', waiting for media...');

      // Listen for offer candidates
      roomRef.child('offerCandidates').on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    }

    async function hangUp() {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
      fullscreenBtn.style.display = 'none';
      logStatus('Call ended.');
      hangupBtn.disabled = true;
    }

    fullscreenBtn.onclick = () => {
      if (!document.fullscreenElement) {
        remoteVideo.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    };

    shareBtn.onclick = startShare;
    joinBtn.onclick = joinRoom;
    hangupBtn.onclick = hangUp;
  </script>
</body>
</html>
